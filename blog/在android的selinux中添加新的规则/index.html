<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="CountStarlight">

<base href="https://countstarlight.github.io/">
<title>


     在Android的selinux中添加新的规则 

</title>
<link rel="canonical" href="https://countstarlight.github.io/blog/%E5%9C%A8android%E7%9A%84selinux%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E8%A7%84%E5%88%99/">







<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>



<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>


<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500|Work+Sans">



    
    <link rel="stylesheet" href="https://countstarlight.github.io/css/light-style.css?t=1496492676">
    




<link rel="shortcut icon"

    href="https://countstarlight.github.io/img/fav.ico"

>








</head>

<body lang="en">
  

<div class="section" id="top">

    <div class="container hero  fade-in one ">
    </div>


<div class="section  fade-in two ">

    <div class="container">
    <hr>
<nav class="nav nav-center">
    <span id="nav-toggle" class="nav-toggle"  onclick="document.getElementById('nav-menu').classList.toggle('is-active');">
      <span></span>
      <span></span>
      <span></span>
    </span>
    <div id="nav-menu" class="nav-left nav-menu">
      <span class="nav-item">
        <a href="https://countstarlight.github.io/">Main</a>
      </span>
      <span class="nav-item">
        <a href="https://countstarlight.github.io/#about">About</a> 
      </span>
    
      <span class="nav-item">
        <a href="https://countstarlight.github.io/#projects">Projects</a> 
      </span>
    
    
      <span class="nav-item">
        <a href="https://countstarlight.github.io/blog">Back to blog</a>
      </span> 
    
      <span class="nav-item">
        <a href="https://countstarlight.github.io/#contact">Contact</a>
      </span>
    
      <span class="nav-item">
        <a href="https://countstarlight.github.io/index.xml"><i class="fa fa-rss"></i></a>
      </span>
    
    </div>
</nav>
<hr>
    </div>

    <div class="container  fade-in two ">
        <h2 class="title is-1 top-pad strong-post-title"><a href="https://countstarlight.github.io/blog/%E5%9C%A8android%E7%9A%84selinux%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E8%A7%84%E5%88%99/">在Android的selinux中添加新的规则</a></h2>
            <div class="post-data">
                Jun 9, 2016 |
                1 minute read
            </div>

            
                <div class="blog-share">
                Share this:
                <a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=Read%20%e5%9c%a8Android%e7%9a%84selinux%e4%b8%ad%e6%b7%bb%e5%8a%a0%e6%96%b0%e7%9a%84%e8%a7%84%e5%88%99%20https%3a%2f%2fcountstarlight.github.io%2fblog%2f%25E5%259C%25A8android%25E7%259A%2584selinux%25E4%25B8%25AD%25E6%25B7%25BB%25E5%258A%25A0%25E6%2596%25B0%25E7%259A%2584%25E8%25A7%2584%25E5%2588%2599%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fcountstarlight.github.io%2fblog%2f%25E5%259C%25A8android%25E7%259A%2584selinux%25E4%25B8%25AD%25E6%25B7%25BB%25E5%258A%25A0%25E6%2596%25B0%25E7%259A%2584%25E8%25A7%2584%25E5%2588%2599%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="fa fa-facebook"></i>
                <span class="hidden">Facebook</span>
                </a>
                <a class="icon-pinterest" href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fcountstarlight.github.io%2fblog%2f%25E5%259C%25A8android%25E7%259A%2584selinux%25E4%25B8%25AD%25E6%25B7%25BB%25E5%258A%25A0%25E6%2596%25B0%25E7%259A%2584%25E8%25A7%2584%25E5%2588%2599%2f&amp;description=%e5%9c%a8Android%e7%9a%84selinux%e4%b8%ad%e6%b7%bb%e5%8a%a0%e6%96%b0%e7%9a%84%e8%a7%84%e5%88%99"
                onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
                <i class="fa fa-pinterest"></i>
                <span class="hidden">Pinterest</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2fcountstarlight.github.io%2fblog%2f%25E5%259C%25A8android%25E7%259A%2584selinux%25E4%25B8%25AD%25E6%25B7%25BB%25E5%258A%25A0%25E6%2596%25B0%25E7%259A%2584%25E8%25A7%2584%25E5%2588%2599%2f"
                onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                <i class="fa fa-linkedin"></i>
                <span class="hidden">Google+</span>
                </a>
                </div>
            

    </div>

    <div class="container markdown  fade-in two  top-pad">
        

<h1 id="一-适用情景">一、适用情景</h1>

<p>当在init.rc中新增service：</p>

<p>service ro_isn /system/bin/isn.sh class late_start user root Oneshot</p>

<p>kernel log会打印以下log：</p>

<p>Warning! Service ro_isn needs a SELinux domain defined; please fix!</p>

<p>这是因为Service ro_isn没有在SELinux的监控之下，这种情况会提示你定义一个SELinux。</p>

<p>在这种情况下，你可以：</p>

<p>1.无视该条log，Service功能不受影响。各种权限不受限制。但是这样做会有风险。</p>

<p>2.为Service ro_isn定义一个SELinux domain，仅添加需要的权限，未允许的权限操作会被拒绝。具体方法请参照下节。</p>

<h1 id="二-解决方法">二、解决方法</h1>

<p>1.在devices/…/sepolicy/目录下新增ro_isn.te文件，内容如下：</p>

<pre><code>type ro_isn, domain; 

type ro_isn_exec, exec_type, file_type;
</code></pre>

<p>2.在devices/…/sepolicy/Android.mk中添加ro_isn.te文件，内容如下：</p>

<pre><code>BOARD_SEPOLICY_UNION := 

... 

        hostapd.te 

        ro_isn.te
</code></pre>

<p>3.在devices/…/sepolicy/file_contexts中增加如下内容：</p>

<pre><code>###################################

#System files

#

...

/system/vendor/bin/slim_ap_daemon               u:object_r:location_exec:s0

/system/bin/isn.sh                       u:object_r:ro_isn_exec:s0
</code></pre>

<p>4.在device/&hellip;/sepolicy/service_contexts中添加：</p>

<pre><code>servicename       u:object_r:ro_isn_service:s0
</code></pre>

<p>5.在init.rc中service ro_isn下添加:</p>

<pre><code>secure context by seclabel 

service ro_isn /system/bin/isn.sh 

class late_start 

user root 

oneshot 

seclabel u:r:ro_isn:s0
</code></pre>

<p>6.编译并烧录bootimage</p>

<ul>
<li>如果编译不成功，失败原因如下：</li>
</ul>

<pre><code>Error while expanding policy

libsepol.check_assertion_helper: neverallow on line 233 of external/sepolicy/domain.te (or line 5194 of policy.conf) violated by allow ro_isn system_file:file { entrypoint };

make: *** [out/target/product/msm8226/obj/ETC/sepolicy_intermediates/sepolicy] 错误 1
</code></pre>

<p>这是因为系统在domain.te中定义了全局的neverallow策略，与ro_isn.te中allow的策略有冲突：</p>

<pre><code>allow ro_isn system_file:file { entrypoint };

neverallow domain { file_type -exec_type }:file entrypoint;
</code></pre>

<p>请确定自己的service有必要需要这个权限。如无必要，请在自己的code中删除掉相关操作；如必要，可以在external/sepolicy/domain.te中冲突的neverallow语句中添加自己为例外：</p>

<pre><code>neverallow {

    domain

    -ro_isn

} { file_type -exec_type }:file entrypoint;
</code></pre>

<ul>
<li>在service ro_isn运行时，出现关于“ro_isn”的avc: denied log</li>
</ul>

<pre><code>&lt;6&gt;[ 13.547188](CPU:0-pid:320:logd.auditd) type=1400 audit(17468992.410:7): avc: denied { entrypoint } for pid=272 comm=&quot;init&quot; path=&quot;/system/bin/isn.sh&quot; dev=&quot;mmcblk0p38&quot; ino=631 scontext=u:r:ro_isn:s0 tcontext=u:object_r:system_file:s0 tclass=file
</code></pre>

<p>a.按照如下规则在ro_isn.te添加权限</p>

<p>SELinux规则语句一般如下：
allow A B:C D;
可以从log中分别获取ABCD四个参数。</p>

<p>比如这行warning log：</p>

<pre><code>avc: denied { entrypoint } for pid=272 comm=&quot;init&quot; path=&quot;/system/bin/isn.sh&quot; dev=&quot;mmcblk0p38&quot; ino=631 scontext=u:r:ro_isn:s0 tcontext=u:object_r:system_file:s0 tclass=file
</code></pre>

<p>那么我们就得出最后的规则是：</p>

<pre><code>allow qcomsysd  block_device:dir { search };

allow ro_isn system_file:file { entrypoint };
</code></pre>

<p>重复该步骤,直到没有关于“ro_isn”的avc: denied log</p>

    </div>

    <div class="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'countstarlight';
    var disqus_identifier = 'https:\/\/countstarlight.github.io\/blog\/%E5%9C%A8android%E7%9A%84selinux%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E8%A7%84%E5%88%99\/';
    var disqus_title = '在Android的selinux中添加新的规则';
    var disqus_url = 'https:\/\/countstarlight.github.io\/blog\/%E5%9C%A8android%E7%9A%84selinux%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E8%A7%84%E5%88%99\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

<div class="container has-text-centered top-pad">
<hr>
<a href="https://countstarlight.github.io/blog/%E5%9C%A8android%E7%9A%84selinux%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E8%A7%84%E5%88%99/#top"><i class="fa fa-arrow-up"></i></a>
<hr>
</div>

<div class="section" id="footer">
    <div class="container has-text-centered">
        
            @2017 CountStarlight
        
    </div>
</div>
</div>
</div>


<script>
$('a[href^="https:\/\/countstarlight.github.io\/blog\/%E5%9C%A8android%E7%9A%84selinux%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E8%A7%84%E5%88%99\/#"]').click(function(e) {
    e.preventDefault();
    var target = this.hash;
    $('html, body').animate({
    scrollTop: $(target).offset().top
    }, 500);
    return false;
})
</script>
